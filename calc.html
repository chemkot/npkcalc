<html>

<head>

</head>
<style>
	table,
	tr,
	td {

		border: 1px solid black;

	}

	table {
		border-collapse: collapse;

	}

	th,
	td {
		padding: 10px;
		text-align: left;
	}

	tr:hover {
		background-color: #f5f5f5;
	}
</style>
<script src="db.js"></script>
<script>
	var selectedFertilizersModel = [];
	var umolUnits = false;
	var calcResult = { elements: [], elementsM: [], nitrogenRelatives: 0, nitrogenRelativesM: 0, ec: 0, ph: 0 };


	function init() {
		document.getElementById("umolUnitsController").checked = false;
		var fertilizersView = document.getElementById("fertilizersView");
		fertilizersView.innerHTML = "";
		selectedFertilizersModel = [];
		fertilizers.forEach(function (item, index) {
			selectedFertilizersModel[index] = { selected: false, concentration: 0 };
			fertilizersView.innerHTML += "<input type=checkbox id=" + "fertilizersView[" + index + "]" + "> " + item["name"] + "<br>";
		});
		var thead = "<td>Удобрения</td><td>Концентрация, мг/л</td>";
		elements.forEach(function (item, index) {
			thead += (umolUnits == false) ? "<td>" + item + ", мг/л</td>" : "<td>" + item + ", ммоль/л</td>";
		});
		var selectedFertilizersViewHead = document.getElementById("selectedFertilizersViewHead");
		selectedFertilizersViewHead.innerHTML = thead;
	}

	function selectedFertilizersModelUpdate() {
		fertilizers.forEach(function (item, index) {
			var ch = document.getElementById("fertilizersView[" + index + "]");
			selectedFertilizersModel[index].selected = ch.checked;
			var concentrationInput = document.getElementById(`concentrationInput${index}`);
			if (document.getElementById(`concentrationInput${index}`) != null) {
				selectedFertilizersModel[index].concentration = parseFloat(concentrationInput.value); //CalcMolarWeight
			}
			else {
				selectedFertilizersModel[index].concentration = 0;
			}
		});


		selectedFertilizersModel.forEach(function (item, index) {
			selectedFertilizersModel[index].elements = [];
			selectedFertilizersModel[index].elementsM = [];
			if (item.selected == true) {
				var weight = item.concentration;
				elements.forEach(function (eitem) {
					var conc = fertilizers[index][eitem];
					if (conc == null) {
						conc = 0;
					}
					if (eitem == "N") {
						if (conc == 0) {
							if (fertilizers[index]["N_NO3"] != null) {
								conc += fertilizers[index]["N_NO3"];
								selectedFertilizersModel[index].elements["N_NO3"] = fertilizers[index]["N_NO3"] * weight;
								selectedFertilizersModel[index].elementsM["N_NO3"] = fertilizers[index]["N_NO3"] * weight / 14;
							}
							if (fertilizers[index]["N_NH4"] != null) {
								conc += fertilizers[index]["N_NH4"];
								selectedFertilizersModel[index].elements["N_NH4"] = fertilizers[index]["N_NH4"] * weight;
								selectedFertilizersModel[index].elementsM["N_NH4"] = fertilizers[index]["N_NH4"] * weight / 14;
							}
						}
					}
					var eWeight = conc * weight;
					selectedFertilizersModel[index].elements[eitem] = eWeight;
					selectedFertilizersModel[index].elementsM[eitem] = eWeight / atomic_weights[eitem];
				});

			}
		});
	}

	function selectedFertilizersViewUpdate() {
		selectedFertilizersModel.forEach(function (item, index) {
			var row = document.getElementById("selectedFertilizersViewItem" + index);
			if (item.selected == false && row != null) {
				row.hidden = true;
			} else if (item.selected == true) {
				if (row != null) {
					row.hidden = false;
					var trow = `<td>${fertilizers[index].name}</td><td><input type='edit' id='concentrationInput${index}' value='${item.concentration}'></td>`;
					elements.forEach(function (eitem) {
						var val = (umolUnits == false) ? +item.elements[eitem].toFixed(4) : +item.elementsM[eitem].toFixed(4);
						trow += "<td>" + val + "</td>";
						// "<td>" + item + ", ммоль/л</td>";
					});
					row.innerHTML = trow;

				} else {
					var selectedFertilizersView = document.getElementById("selectedFertilizersView");
					var trow = `<td>${fertilizers[index].name}</td><td><input type='edit' id='concentrationInput${index}' value='0'></td>`;
					elements.forEach(function (eitem) {
						trow += "<td>" + 0 + "</td>";
					});
					selectedFertilizersView.innerHTML += `<tr id="selectedFertilizersViewItem${index}">${trow}</tr>`;
				}
			}
		});
	}

	function umolUnitsChanged() {
		var ch = document.getElementById("umolUnitsController");
		umolUnits = ch.checked;
		var thead = "<td>Удобрения</td><td>Концентрация, мг/л</td>";
		elements.forEach(function (item, index) {
			thead += (umolUnits == false) ? "<td>" + item + ", мг/л</td>" : "<td>" + item + ", ммоль/л</td>";
		});
		var selectedFertilizersViewHead = document.getElementById("selectedFertilizersViewHead");
		selectedFertilizersViewHead.innerHTML = thead;
		selectedFertilizersModelUpdate();
		selectedFertilizersViewUpdate();
		calculate();
		UpdateCalcResultsView();
	}


	function selectedFertilizersControllerEvent() {
		selectedFertilizersModelUpdate();
		selectedFertilizersViewUpdate();
		calculate();
		UpdateCalcResultsView();
	}

	function calculate() {
		calcResult.elements = [];
		calcResult.elementsM = [];


		selectedFertilizersModel.forEach(function (item, index) {
			if (item.selected == true) {
				elements.forEach(function (eitem) {
					if (calcResult.elements[eitem] == null)
						calcResult.elements[eitem] = 0;
					if (calcResult.elementsM[eitem] == null)
						calcResult.elementsM[eitem] = 0;
					calcResult.elements[eitem] += item.elements[eitem];
					calcResult.elementsM[eitem] += item.elementsM[eitem];
				});
				if (calcResult.elements["N_NO3"] == null)
					calcResult.elements["N_NO3"] = 0;
				if (calcResult.elements["N_NH4"] == null)
					calcResult.elements["N_NH4"] = 0;
				if (calcResult.elementsM["N_NO3"] == null)
					calcResult.elementsM["N_NO3"] = 0;
				if (calcResult.elementsM["N_NH4"] == null)
					calcResult.elementsM["N_NH4"] = 0;
				if (item.elements["N_NO3"] != null) {
					calcResult.elements["N_NO3"] += item.elements["N_NO3"];
					calcResult.elementsM["N_NO3"] += item.elementsM["N_NO3"];
				}
				if (item.elements["N_NH4"] != null) {
					calcResult.elements["N_NH4"] += item.elements["N_NH4"];
					calcResult.elementsM["N_NH4"] += item.elementsM["N_NH4"];
				}
			}
		});

		calcResult.nitrogenRelatives = calcResult.elements["N_NO3"] / calcResult.elements["N_NH4"];
		calcResult.nitrogenRelativesM = calcResult.elementsM["N_NO3"] / calcResult.elementsM["N_NH4"];
	}

	function UpdateCalcResultsView() {
		console.log(calcResult);
		var nitrogenRelativesView = document.getElementById("nitrogenRelativesView");
		nitrogenRelativesView.innerHTML = (umolUnits == false) ? calcResult.nitrogenRelatives : calcResult.nitrogenRelativesM;

		var norma = 1;
		var n = (umolUnits == false) ? calcResult.elements["N"] : calcResult.elementsM["N"];
		var p = (umolUnits == false) ? calcResult.elements["P"] : calcResult.elementsM["P"];
		var k = (umolUnits == false) ? calcResult.elements["K"] : calcResult.elementsM["K"];

		//norma = (n > 0) ? n : norma;
		//norma = (p > 0 && p < norma) ? p : norma;
		//norma = (k > 0 && k < norma) ? k : norma;
		norma = n;

		var npk = "";
		var legend = "";

		elements.forEach(function (item) {
			if (item != "N_NO3" && item != "N_NH4") {
				npk += (umolUnits == false) ? +(calcResult.elements[item] / norma).toFixed(3) + " : " : +(calcResult.elementsM[item] / norma).toFixed(3) + " : ";
				legend += item + " : ";
			}
		});

		var elementsRelativesView = document.getElementById("elementsRelativesView");
		elementsRelativesView.innerHTML = npk;
		var elementsRelativesLegend = document.getElementById("elementsRelativesLegend");
		elementsRelativesLegend.innerHTML = legend;

	}




</script>

<body onload="init()">

	<form onchange="selectedFertilizersControllerEvent()">
		<p><b>Выбор компонентов раствора</b></p>
		<p id=fertilizersView>
		</p>
	</form>

	<table style="width:100%">
		<thead>
			<tr id=selectedFertilizersViewHead>
			</tr>
		</thead>
		<tbody id="selectedFertilizersView" onchange="selectedFertilizersControllerEvent()">
		</tbody>
	</table>

	<form>
		<input type=checkbox id="umolUnitsController" onchange="umolUnitsChanged()" checked="false">мкмоль/л вместо
		мг/л<br>
		<b>
			<p id=elementsRelativesLegend>N:P:K</p>
		</b>
		<p id=elementsRelativesView>
		</p>
		<p><b>N(NO3+) : N(NH4-)</b></p>
		<p id=nitrogenRelativesView>
		</p>
		<p><b>EC, мкСм/см:</b></p>
		<p id=ecView>
		</p>
	</form>

</body>

</html>