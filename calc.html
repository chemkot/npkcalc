<!DOCTYPE html>
<html lang="en-US">
<meta charset="utf-8">

<head>

</head>
<style>
	table,
	thead,
	tbody,
	tfoot,
	tr,
	td, th {
		
		
		border: 1px solid black;
		border-collapse: collapse;
		padding: 10px;
		text-align: left;

	}

	table{
		
	}

	tr:hover {
		background-color: #f5f5f5;
	}



	
	

	
</style>
<script src="db.js"></script>
<script>
	var selectedFertilizersModel = [];
	var umolUnits = false;
	var calcResult = { elements: [], elementsM: [], nitrogenRelatives: 0, nitrogenRelativesM: 0, ec: 0, ph: 0 };


	function init() {
		document.getElementById("umolUnitsController").checked = false;
		var fertilizersView = document.getElementById("fertilizersView");
		fertilizersView.innerHTML = "";
		selectedFertilizersModel = [];
		fertilizers.forEach(function (item, index) {
			selectedFertilizersModel[index] = { selected: false, concentration: 0 };
			if (fertilizers[index]["N"] == 0 || fertilizers[index]["N"] == null) {
				fertilizers[index]["N"] = 0;
				if (fertilizers[index]["N_NO3"] != null)
					fertilizers[index]["N"] += fertilizers[index]["N_NO3"];
				if (fertilizers[index]["N_NH4"] != null)
					fertilizers[index]["N"] += fertilizers[index]["N_NH4"];
			} else {
				if (fertilizers[index]["N"] != fertilizers[index]["N_NO3"] + fertilizers[index]["N_NH4"]) alert("Fertilizer " + fertilizers[index][name] + " nitrogen error!")
			}
			fertilizersView.innerHTML += "<input type=checkbox id=" + "fertilizersView[" + index + "]" + "> " + item["name"] + "<br>";

		});

		tableHeadUpdate();

		var tElementsAmount = "<td>Концентрация элементов в растворе</td><td>сумма</td>";
		elements.forEach(function (item, index) {
			tElementsAmount += "<td>" + "0" + "</td>";
		});
		tElementsAmount = "<tr>" + tElementsAmount + "</tr>";
		var elementsAmountView = document.getElementById("elementsAmountView");
		elementsAmountView.innerHTML = tElementsAmount;
	}

	function selectedFertilizersModelUpdate() {
		fertilizers.forEach(function (item, index) {
			var ch = document.getElementById("fertilizersView[" + index + "]");
			selectedFertilizersModel[index].selected = ch.checked;
			var concentrationInput = document.getElementById(`concentrationInput${index}`);
			if (document.getElementById(`concentrationInput${index}`) != null) {
				selectedFertilizersModel[index].concentration = parseFloat(concentrationInput.value); //CalcMolarWeight
			}
			else {
				selectedFertilizersModel[index].concentration = 0;
			}
		});


		selectedFertilizersModel.forEach(function (item, index) {
			selectedFertilizersModel[index].elements = [];
			selectedFertilizersModel[index].elementsM = [];
			if (item.selected == true) {
				var weight = item.concentration;
				elements.forEach(function (eitem) {
					var conc = fertilizers[index][eitem];
					if (conc == null) {
						conc = 0;
					}
					var eWeight = conc * weight;
					selectedFertilizersModel[index].elements[eitem] = eWeight;
					selectedFertilizersModel[index].elementsM[eitem] = eWeight / atomic_weights[eitem];
				});

			}
		});
	}

	function selectedFertilizersViewUpdate() {
		selectedFertilizersModel.forEach(function (item, index) {
			var row = document.getElementById("selectedFertilizersViewItem" + index);
			if (item.selected == false && row != null) {
				row.hidden = true;
			} else if (item.selected == true) {
				if (row != null) {
					row.hidden = false;
					var trow = `<td>${fertilizers[index].name}</td><td><input type='edit' id='concentrationInput${index}' value='${item.concentration}'></td>`;
					elements.forEach(function (eitem) {
						var val = (umolUnits == false) ? +item.elements[eitem].toFixed(4) : +item.elementsM[eitem].toFixed(4);
						trow += "<td>" + val + "</td>";
					});
					row.innerHTML = trow;

				} else {
					var selectedFertilizersView = document.getElementById("selectedFertilizersView");
					var trow = `<td>${fertilizers[index].name}</td><td><input type='edit' id='concentrationInput${index}' value='0'></td>`;
					elements.forEach(function (eitem) {
						trow += "<td>" + 0 + "</td>";
					});
					selectedFertilizersView.innerHTML += `<tr id="selectedFertilizersViewItem${index}">${trow}</tr>`;
				}
			}
		});
	}

	function tableHeadUpdate() {
		var thead = "<td>Удобрения</td><td>Концентрация, мг/л</td>";
		elements.forEach(function (item, index) {
			var text = item;
			if (ions[item] >= 1) {
				text = "<font color='red'>" + text + "</font>";
			} else if (ions[item] <= -1) {
				text = "<font color='blue'>" + text + "</font>";
			}
			thead += (umolUnits == false) ? "<td>" + text + ", мг/л</td>" : "<td>" + text + ", ммоль/л</td>";
		});
		var selectedFertilizersViewHead = document.getElementById("selectedFertilizersViewHead");
		selectedFertilizersViewHead.innerHTML = thead;
	}

	function umolUnitsChanged() {
		var ch = document.getElementById("umolUnitsController");
		umolUnits = ch.checked;
		tableHeadUpdate();
		selectedFertilizersModelUpdate();
		selectedFertilizersViewUpdate();
		calculate();
		UpdateCalcResultsView();
	}


	function selectedFertilizersControllerEvent() {
		selectedFertilizersModelUpdate();
		selectedFertilizersViewUpdate();
		calculate();
		UpdateCalcResultsView();
	}

	function calculate() {
		calcResult.elements = [];
		calcResult.elementsM = [];


		selectedFertilizersModel.forEach(function (item, index) {
			if (item.selected == true) {
				elements.forEach(function (eitem) {
					if (calcResult.elements[eitem] == null)
						calcResult.elements[eitem] = 0;
					if (calcResult.elementsM[eitem] == null)
						calcResult.elementsM[eitem] = 0;
					calcResult.elements[eitem] += item.elements[eitem];
					calcResult.elementsM[eitem] += item.elementsM[eitem];
				});
			}
		});

		calcResult.nitrogenRelatives = calcResult.elements["N_NO3"] / calcResult.elements["N_NH4"];
		calcResult.nitrogenRelativesM = calcResult.elementsM["N_NO3"] / calcResult.elementsM["N_NH4"];

		calcResult.nitrogenNH4PercentRelatives = calcResult.elements["N_NH4"] / calcResult.elements["N"];
		calcResult.nitrogenNH4PercentRelativesM = calcResult.elementsM["N_NH4"] / calcResult.elementsM["N"];



	}

	function UpdateCalcResultsView() {
		console.log(calcResult);
		// вывод полного соотношения элементов
		var tElementsAmount = "<td>Концентрация элементов в растворе</td><td>сумма</td>";
		elements.forEach(function (item, index) {
			tElementsAmount += (umolUnits == false) ? "<td>" + +calcResult.elements[item].toFixed(4) + "</td>" : "<td>" + +calcResult.elementsM[item].toFixed(4) + "</td>";
		});
		tElementsAmount = "<tr>" + tElementsAmount + "</tr>";
		var elementsAmountView = document.getElementById("elementsAmountView");
		elementsAmountView.innerHTML = tElementsAmount;


		var nitrogenRelativesView = document.getElementById("nitrogenRelativesView");
		nitrogenRelativesView.innerHTML = (umolUnits == false) ? +calcResult.nitrogenRelatives.toFixed(2) : +calcResult.nitrogenRelativesM.toFixed(2);

		var nh4percent = (umolUnits == false) ? +(100 * calcResult.elements["N_NH4"] / calcResult.elements["N"]).toFixed(1) : +(100 * calcResult.elementsM["N_NH4"] / calcResult.elementsM["N"]).toFixed(1)
		var nitrogenNH4percentRelativesView = document.getElementById("nitrogenNH4percentRelativesView");
		nitrogenNH4percentRelativesView.innerHTML = nh4percent;

		var norma = 1;
		var n = (umolUnits == false) ? calcResult.elements["N"] : calcResult.elementsM["N"];
		var p = (umolUnits == false) ? calcResult.elements["P"] : calcResult.elementsM["P"];
		var k = (umolUnits == false) ? calcResult.elements["K"] : calcResult.elementsM["K"];
		norma = n;
		if (k < norma) norma = k;
		if (p < norma) norma = p;
		var nNorm = n / norma;
		var pNorm = p / norma;
		var kNorm = k / norma;
		var NPKRelativesView = document.getElementById("NPKRelativesView");
		NPKRelativesView.innerHTML = +nNorm.toFixed(2) + " : " + +pNorm.toFixed(2) + " : " + +kNorm.toFixed(2);

		norma = n;
		if (k < norma) norma = k;
		nNorm = n / norma;
		kNorm = k / norma;
		var NKRelativesView = document.getElementById("NKRelativesView");
		NKRelativesView.innerHTML = +nNorm.toFixed(2) + " : " + +kNorm.toFixed(2);

		var ca = (umolUnits == false) ? calcResult.elements["Ca"] : calcResult.elementsM["Ca"];
		var mg = (umolUnits == false) ? calcResult.elements["Mg"] : calcResult.elementsM["Mg"];
		norma = ca;
		if (mg < norma) norma = mg;
		if (k < norma) norma = k;
		var caNorm = ca / norma;
		var mgNorm = mg / norma;
		kNorm = k / norma;

		var KCaMgRelativesView = document.getElementById("KCaMgRelativesView");
		KCaMgRelativesView.innerHTML = +kNorm.toFixed(2) + " : " + +caNorm.toFixed(2) + " : " + +mgNorm.toFixed(2);


	}



</script>

<body onload="init()">

	<form onchange="selectedFertilizersControllerEvent()">
		<p><b>Выбор компонентов раствора</b></p>
		<p id=fertilizersView>
		</p>
	</form>

	<table style="width:100%">
		<thead>
			<tr id="selectedFertilizersViewHead">
			</tr>
		</thead>
		<tbody id="selectedFertilizersView" onchange="selectedFertilizersControllerEvent()">
		</tbody>
		<tfoot id="elementsAmountView">

		</tfoot>
	</table>
	<br>
	<table style="width:40%">
		<thead>
			<tr>
				<td>Элементы</td>
				<td>Соотношение</td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>N:P:K нормированное</td>
				<td id="NPKRelativesView">0:0:0</td>
			</tr>
			<tr>
				<td>K:Ca:Mg нормированное</td>
				<td id="KCaMgRelativesView">0:0:0</td>
			</tr>
			<tr>
				<td>N:K нормированное</td>
				<td id="NKRelativesView">0:0</td>
			</tr>

			<tr>
				<td>N(NO3-):N(NH4+-)</td>
				<td id="nitrogenRelativesView">0:0</td>
			</tr>
			<tr>
				<td>N(NH4+):N(summ), %</td>
				<td id="nitrogenNH4percentRelativesView">0:0</td>
			</tr>




		</tbody>

	</table>



	<form>
		<input type=checkbox id="umolUnitsController" onchange="umolUnitsChanged()" checked="false">ммоль/л вместо
		мг/л<br>



		<p style="visibility: hidden;"><b>EC, мкСм/см:</b></p>
		<p id=ecView>
		</p>
	</form>

</body>

</html>